<script>
    // Элементы DOM
    const addBarberModal = document.getElementById('addBarberModal');
    const masterLoginModal = document.getElementById('masterLoginModal');
    const addBarberForm = document.getElementById('addBarberForm');
    const masterLoginForm = document.getElementById('masterLoginForm');
    const barbersGrid = document.getElementById('barbersGrid');
    const emptyState = document.getElementById('emptyState');
    
    // Открыть модальное окно добавления барбера
    function openAddBarberModal() {
        addBarberModal.style.display = 'flex';
    }
    
    // Закрыть модальное окно добавления барбера
    function closeAddBarberModal() {
        addBarberModal.style.display = 'none';
        addBarberForm.reset();
    }
    
    // Открыть модальное окно входа мастера
    function openMasterLoginModal() {
        masterLoginModal.style.display = 'flex';
    }
    
    // Закрыть модальное окно входа мастера
    function closeMasterLoginModal() {
        masterLoginModal.style.display = 'none';
        masterLoginForm.reset();
    }
    
    // Загрузка барберов пользователя
    async function loadUserBarbers() {
        try {
            const response = await fetch('/get_user_barbers');
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.barbers.length > 0) {
                    renderBarbers(data.barbers);
                } else {
                    // Показываем пустое состояние
                    barbersGrid.innerHTML = `
                        <div class="empty-state">
                            У вас пока нет добавленных барберов<br>
                            Нажмите "+" чтобы добавить первого
                        </div>
                    `;
                }
            } else {
                console.error('Server error:', response.status);
            }
        } catch (error) {
            console.error('Error loading barbers:', error);
        }
    }
    
    // Функция для добавления барбера по коду
    async function addBarberByCode(masterCode) {
        try {
            const formData = new FormData();
            formData.append('master_code', masterCode);
            
            const response = await fetch('/add_barber', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                renderBarbers(result.barbers);
                return true;
            } else {
                alert(result.message);
                return false;
            }
        } catch (error) {
            console.error('Error adding barber:', error);
            alert('Ошибка подключения к серверу');
            return false;
        }
    }
    
    // Добавление барбера по коду
    addBarberForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const masterCode = document.getElementById('masterCode').value.trim().toUpperCase();
        
        if (!masterCode) {
            alert('Введите код барбера');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('master_code', masterCode);
            
            const response = await fetch('/add_barber', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                closeAddBarberModal();
                
                // Обновляем список барберов
                if (result.barbers && result.barbers.length > 0) {
                    renderBarbers(result.barbers);
                } else {
                    loadUserBarbers();
                }
                
                alert(result.message || 'Барбер успешно добавлен!');
            } else {
                alert(result.message || 'Ошибка при добавлении барбера');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Произошла ошибка при подключении к серверу');
        }
    });
    
    // Вход мастера
    masterLoginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const loginCode = document.getElementById('loginCode').value.trim().toUpperCase();
        const password = document.getElementById('password').value;
        
        if (!loginCode || !password) {
            alert('Введите код и пароль');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('login_code', loginCode);
            formData.append('password', password);
            
            const response = await fetch('/master_login', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Успешный вход! Перенаправляем...');
                // Перенаправляем на панель мастера
                if (result.redirect) {
                    window.location.href = result.redirect;
                }
            } else {
                alert(result.message || 'Ошибка при входе');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Произошла ошибка при подключении к серверу');
        }
    });
    
    // Рендеринг списка барберов
    function renderBarbers(barbers) {
        if (!barbers || barbers.length === 0) {
            barbersGrid.innerHTML = `
                <div class="empty-state">
                    У вас пока нет добавленных барберов<br>
                    Нажмите "+" чтобы добавить первого
                </div>
            `;
            return;
        }
        
        barbersGrid.innerHTML = barbers.map(barber => `
            <div class="barber-card">
                <img src="${barber.avatar || '/static/default_barber.png'}" 
                     alt="${barber.name}" 
                     class="barber-avatar"
                     onerror="this.src='/static/default_barber.png'">
                <div class="barber-name">${barber.name}</div>
                <div class="barber-code">Код: ${barber.code}</div>
                <button style="margin-top: 10px; padding: 5px 10px; background: #4a6fa5; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;" 
                        onclick="bookWithBarber('${barber.code}')">
                    Записаться
                </button>
            </div>
        `).join('');
    }
    
    // Функция записи к барберу
    function bookWithBarber(masterCode) {
        alert(`Функция записи к барберу ${masterCode}\nЗдесь будет открытие окна записи`);
        // Здесь можно открыть новое модальное окно для записи
    }
    
    // Закрытие модальных окон при клике вне их
    window.addEventListener('click', function(e) {
        if (e.target === addBarberModal) {
            closeAddBarberModal();
        }
        if (e.target === masterLoginModal) {
            closeMasterLoginModal();
        }
    });
    
    // Инициализация при загрузке страницы
    window.addEventListener('DOMContentLoaded', () => {
        loadUserBarbers();
        
        // Фокус на поле ввода при открытии модального окна
        document.getElementById('addBarberModal')?.addEventListener('shown', function() {
            document.getElementById('masterCode')?.focus();
        });
    });
</script>
